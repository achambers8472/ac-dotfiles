#!/usr/bin/env python

import re
import sys
import urllib2
import contextlib


ARTICLE_LINE_REGEXP = re.compile("(?i)\@ARTICLE\{(.*?:.*?),")
RECORD_ID_REGEXP = re.compile("recid=(\d*)")
BIBTEX_RECORD_REGEXP = re.compile("(?ms)(@article.*?\})\s*</pre>")


def url_text(url):
    with contextlib.closing(urllib2.urlopen(url)) as page:
        return page.read()


def bibtex_url(article_id):
    return "".join(["https://inspirehep.net/record/",
                    record_id(article_id),
                    "/export/hx"])


def search_url(article_id):
    return "".join(["https://inspirehep.net/search?ln=en&p=find+texkey+",
                    article_id.replace(":", "%3A")])


def record_id(article_id):
    match = re.search(RECORD_ID_REGEXP,
                      url_text(search_url(article_id)))
    if match:
        return match.group(1)
    else:
        raise ValueError("Cannot find record number for " + article_id)


def article_ids_from_bib(filename):
    article_ids = []
    with open(filename) as ref_file:
        for line in ref_file:
            match = re.search(ARTICLE_LINE_REGEXP, line)
            if match:
                article_ids.append(match.group(1))
    return article_ids


def bibtex_entry(article_id):
    match = re.search(BIBTEX_RECORD_REGEXP,
                      url_text(bibtex_url(article_id)))
    if match:
        return format_bibtex_entry(match.group(1))
    else:
        raise ValueError("Cannot find bibtex entry for " + article_id)


def format_bibtex_entry(bibtex_entry):
    return bibtex_entry


article_ids = article_ids_from_bib(sys.argv[1])
for aid in sorted(article_ids):
    print bibtex_entry(aid)
